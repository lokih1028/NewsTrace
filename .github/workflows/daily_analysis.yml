name: ðŸ“Š NewsTrace æ¯æ—¥åˆ†æž

on:
  # å®šæ—¶è§¦å‘ - æ¯ä¸ªå·¥ä½œæ—¥ 18:00 (åŒ—äº¬æ—¶é—´)
  schedule:
    - cron: '0 10 * * 1-5'  # UTC 10:00 = åŒ—äº¬ 18:00
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full      # å®Œæ•´åˆ†æž
          - audit     # ä»…å®¡è®¡
          - tracking  # ä»…è¿½è¸ªæ›´æ–°

env:
  PYTHON_VERSION: '3.11'
  TZ: 'Asia/Shanghai'

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ðŸ é…ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ”§ é…ç½®çŽ¯å¢ƒ
        run: |
          mkdir -p data
          if [ -f "data/newstrace.db" ]; then
            echo "âœ… å‘çŽ°åŽ†å²æ•°æ®åº“"
          else
            echo "ðŸ“ åˆå§‹åŒ–æ–°æ•°æ®åº“"
          fi
      
      - name: ðŸš€ è¿è¡Œåˆ†æž
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          LLM_PROVIDER: gemini
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          RUN_MODE: ${{ github.event.inputs.mode || 'full' }}
          WATCH_KEYWORDS: ${{ secrets.WATCH_KEYWORDS }}
        run: |
          python run_actions.py
      
      - name: ðŸ’¾ ä¿å­˜æ•°æ®
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newstrace-data-${{ github.run_number }}
          path: |
            data/newstrace.db
            data/reports/
          retention-days: 30
      
      - name: ðŸ“Š ç”ŸæˆæŠ¥å‘Šæ‘˜è¦
        if: success()
        run: |
          echo "## ðŸ“Š NewsTrace åˆ†æžå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œæ¨¡å¼: ${{ github.event.inputs.mode || 'full' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/summary.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### åˆ†æžç»“æžœ" >> $GITHUB_STEP_SUMMARY
            cat data/summary.json >> $GITHUB_STEP_SUMMARY
          fi
